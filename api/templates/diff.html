<div class="card shadow-sm">
    <div class="card-body">

        <h2 class="h5 mb-4">План синхронизации схемы БД</h2>

        {% if plan.create_tables %}
        <div class="mb-4">
            <h6>
                Таблицы для создания
                <span class="badge bg-success ms-2">safe</span>
            </h6>
            <ul class="list-group list-group-flush">
                {% for table in plan.create_tables %}
                <li class="list-group-item">
                    <code>{{ table }}</code>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if plan.add_columns %}
        <div class="mb-4">
            <h6>
                Колонки для добавления
                <span class="badge bg-success ms-2">safe</span>
            </h6>

            {% for table, cols in plan.add_columns.items() %}
            <div class="mb-2">
                <strong><code>{{ table }}</code></strong>
                <ul class="mb-1">
                    {% for col, col_type in cols.items() %}
                    <li>
                        <code>{{ col }}</code>
                        <span class="text-muted">({{ col_type }})</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if plan.warnings %}
        <div class="mb-4">
            <h6>
                Потенциально опасные изменения помечаются как
                <span class="badge bg-danger me-2">MANUAL</span>
            </h6>

            <ul class="list-group list-group-flush">
                {% for warning in plan.warnings %}
                <li class="list-group-item">
                    {% if warning.level == "MANUAL" %}
                        <span class="badge bg-danger me-2">MANUAL</span>
                    {% else %}
                        <span class="badge bg-warning text-dark me-2">WARNING</span>
                    {% endif %}
                    {{ warning.message }}
                </li>
                {% endfor %}
            </ul>

            <div class="alert alert-warning mt-3 mb-0">
                Эти изменения <strong>не применяются автоматически</strong> и
                требуют отдельной миграции после ручного ревью.
            </div>
        </div>
        {% endif %}

        <div class="d-flex flex-wrap gap-2 mt-4">

            {# APPLY SAFE SCHEMA #}
            {% if plan.create_tables or plan.add_columns %}
            <form hx-post="/confirm_schema" hx-target="#diff-container">
                <input type="hidden" name="source_url" value="{{ source_url }}">
                <input type="hidden" name="target_url" value="{{ target_url }}">
                <button class="btn btn-success">
                    Применить безопасные изменения схемы
                </button>
            </form>
            {% endif %}

            <form hx-get="/conflicts" hx-target="#diff-container">
                <input type="hidden" name="source_url" value="{{ source_url }}">
                <input type="hidden" name="target_url" value="{{ target_url }}">
                <button type="submit" class="btn btn-outline-secondary">
                    Просмотреть конфликты данных
                </button>
            </form>

            <form hx-post="/sync_data" hx-target="#diff-container">
                <input type="hidden" name="source_url" value="{{ source_url }}">
                <input type="hidden" name="target_url" value="{{ target_url }}">
                <input type="hidden" name="pk_strategy" value="{{ pk_strategy }}">
                <button class="btn btn-primary">
                    Синхронизировать данные
                </button>
            </form>
        </div>
    </div>
</div>
